name: Release

on:
  push:
    tags:
      - 'v*'

# é»˜è®¤æœ€å°æƒé™ï¼ˆreadï¼‰ã€‚éœ€è¦å†™æƒé™æ—¶å†åœ¨ä½œä¸šçº§åˆ«æ‰“å¼€ã€‚
permissions:
  contents: read

jobs:
  # åˆ›å»º draft releaseï¼ŒåŒæ—¶æ£€æµ‹è§¦å‘è€…æ˜¯å¦ä¸ºä»“åº“å†…å¯å†™/ç®¡ç†å‘˜ (trusted)
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create-release.outputs.release_id }}
      trusted: ${{ steps.create-release.outputs.trusted }}
    permissions:
      contents: write   # ä»…æ­¤ä½œä¸šéœ€è¦å†™ release çš„æƒé™
    steps:
      - name: Create draft release and check actor permission
        id: create-release
        uses: actions/github-script@v7
        with:
          script: |
            const actor = context.actor;
            // æŸ¥è¯¢è§¦å‘è€…åœ¨ä»“åº“ä¸­çš„æƒé™
            const perm = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: actor
            });
            const p = perm.data.permission || '';
            const trusted = (p === 'admin' || p === 'write' || p === 'maintain');
            // åˆ›å»º draft releaseï¼ˆä¸€ç›´åˆ›å»ºä¸º draftï¼‰
            const releaseBody = [
              '## Photo Truck ' + context.ref_name,
              '',
              '### ğŸ“¥ ä¸‹è½½',
              '',
              'è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„å®‰è£…åŒ…ï¼š',
              '',
              '- **macOS**: ä¸‹è½½ `.dmg` æ–‡ä»¶',
              '- **Windows**: ä¸‹è½½ `.msi` æˆ– `.exe` æ–‡ä»¶',
              '- **Linux**: ä¸‹è½½ `.deb` æˆ– `.AppImage` æ–‡ä»¶',
              '',
              '### âš ï¸ å‰ç½®è¦æ±‚',
              '',
              'è¿è¡Œ Photo Truck éœ€è¦å®‰è£… [ExifTool](https://exiftool.org/):',
              '',
              '- macOS: `brew install exiftool`',
              '- Windows: ä»å®˜ç½‘ä¸‹è½½å®‰è£…',
              '- Linux: `sudo apt install libimage-exiftool-perl`'
            ].join('\n');
            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: context.ref_name,
              name: 'Photo Truck ' + context.ref_name,
              body: releaseBody,
              draft: true,
              prerelease: false
            });
            core.setOutput('release_id', String(release.data.id));
            core.setOutput('trusted', String(trusted));
            core.info(`Actor ${actor} permission: ${p}, trusted: ${trusted}`);
  # æ„å»ºï¼ˆmatrix å¤šå¹³å°ï¼‰ï¼Œå¯¹ä»»æ„è§¦å‘è€…éƒ½ä¼šè¿è¡Œ
  build-tauri:
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
          - platform: 'ubuntu-22.04'
            args: ''
          - platform: 'windows-latest'
            args: ''
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false   # é˜²æ­¢å°† GITHUB_TOKEN å†™å…¥ git config
      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - name: Install Rust stable
        uses: dtolnay/rust-action@stable
      - name: Add Rust target (macOS)
        if: matrix.platform == 'macos-latest'
        run: |
          if [[ "${{ matrix.args }}" == *"aarch64"* ]]; then
            rustup target add aarch64-apple-darwin
          else
            rustup target add x86_64-apple-darwin
          fi
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
      - name: Install frontend dependencies
        run: npm ci
      - name: Build the app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}   # ä»…ç”¨äºæ„å»ºæµç¨‹ä¸­éœ€è¦çš„ API è¯·æ±‚ï¼ˆå°½é‡ä¸è¦ç”¨å®ƒæ¨é€ï¼‰
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}
          args: ${{ matrix.args }}

  # è‡ªåŠ¨å‘å¸ƒï¼šå½“è§¦å‘è€…è¢«è®¤ä¸ºæ˜¯ trustedï¼ˆrepo å†…å†™æƒé™çš„äººï¼‰æ—¶è‡ªåŠ¨æŠŠ draft->published
  publish-auto:
    needs: [create-release, build-tauri]
    if: ${{ needs.create-release.outputs.trusted == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Publish release automatically (trusted actor)
        uses: actions/github-script@v7
        env:
          RELEASE_ID: ${{ needs.create-release.outputs.release_id }}
        with:
          script: |
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: parseInt(process.env.RELEASE_ID, 10),
              draft: false
            });

  # æ‰‹åŠ¨å‘å¸ƒï¼šå½“è§¦å‘è€…ä¸å¯ä¿¡æ—¶ï¼ˆtrusted == falseï¼‰éœ€è¦ç¯å¢ƒå®¡æ‰¹ï¼ˆenvironment: publishï¼‰
  publish-manual:
    needs: [create-release, build-tauri]
    if: ${{ needs.create-release.outputs.trusted == 'false' }}
    runs-on: ubuntu-latest
    environment: publish   # éœ€è¦åœ¨ä»“åº“ Settings -> Environments åˆ›å»º publish å¹¶é…ç½® reviewers
    permissions:
      contents: write
    steps:
      - name: Publish release after manual approval
        # ä½¿ç”¨ä¸€ä¸ªå—é™çš„ PATï¼ˆåœ¨ä»“åº“ Secrets ä¸­é…ç½®ä¸º PUBLISH_PATï¼‰
        env:
          RELEASE_ID: ${{ needs.create-release.outputs.release_id }}
          GITHUB_TOKEN: ${{ secrets.PUBLISH_PAT }}
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: parseInt(process.env.RELEASE_ID, 10),
              draft: false
            });
